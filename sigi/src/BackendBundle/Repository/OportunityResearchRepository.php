<?php

namespace BackendBundle\Repository;
use Doctrine\Common\Collections\ArrayCollection;

/**
 * OportunityResearchRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OportunityResearchRepository extends \Doctrine\ORM\EntityRepository
{
	public function findOportunitiesByUserId($id)
	{
        $returnResults = null;

	    $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                JOIN o.mainMentor mm
                JOIN mm.user mmu
                WHERE mmu.id = :id'
            )->setParameter('id', $id);
     
        try {
            $mainResults = $query->getResult();

            if (count($mainResults) > 0 )
                $returnResults = $mainResults;
            
        } catch (\Doctrine\ORM\NoResultException $e) {
            
        }

        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                JOIN o.secondaryMentor mm
                JOIN mm.user mmu
                WHERE mmu.id = :id'
            )->setParameter('id', $id);
     
        try {
            $secondaryResults = $query->getResult();

            if (count($secondaryResults) > 0 )
                if(is_null($returnResults))
                    $returnResults = $secondaryResults;
                else
                    $returnResults = array_merge($returnResults,$secondaryResults);
            
        } catch (\Doctrine\ORM\NoResultException $e) {
            
        }

        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                JOIN o.thertiaryMentor mm
                JOIN mm.user mmu
                WHERE mmu.id = :id'
            )->setParameter('id', $id);
     
        try {
            $thertiaryResults = $query->getResult();

            if (count($thertiaryResults) > 0 )
                if(is_null($returnResults))
                    $returnResults = $thertiaryResults;
                else
                    $returnResults = array_merge($returnResults,$thertiaryResults);
            
        } catch (\Doctrine\ORM\NoResultException $e) {
            
        }

        return $returnResults;
	}

    public function findConcreteApplications()
    {
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                JOIN o.applications a
                WHERE a.state = 3
                OR a.state = 4
                OR a.state = 5'
            );
     
        try {
            return $query->getResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }   
    }

    public function countConcreteApplicationes()
    {
        return count($this->findConcreteApplications());
    }

	public function findPublic()
	{
	    $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                WHERE o.publish = true
                AND o.public = true'
            );
     
        try {
            return $query->getResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }
	}

    public function findPublished()
    {
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT o FROM BackendBundle:OportunityResearch o
                WHERE o.publish = true'
            );
     
        try {
            return $query->getResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }
    }

    public function findMentorFaculties()
    {
        $query = $this->getEntityManager()
            ->createQuery(
                'SELECT m.id, f.id FROM BackendBundle:Mentor m
                JOIN m.department d 
                JOIN d.faculty f'
            );
     
        try {
            return $query->getResult();
        } catch (\Doctrine\ORM\NoResultException $e) {
            return null;
        }   
    }
}
